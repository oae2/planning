<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>OAE QR Genrate (Advance)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
</head>
<body class="flex bg-gray-100 h-screen">

  <!-- Sidebar -->
  <aside class="w-64 bg-white shadow-md p-4 hidden md:block">
    <div class="text-xl font-bold mb-4 text-blue-600">OAE QR Genrate</div>
    <nav class="space-y-3">
      <a href="#qr" class="nav-link block px-3 py-2 rounded hover:bg-gray-200">QR Code Generator</a>
      <a href="#shorturl" class="nav-link block px-3 py-2 rounded hover:bg-gray-200">Short URL</a>
      <a href="#" class="block px-3 py-2 rounded hover:bg-gray-200">PDF Tools</a>
      <a href="#" class="block px-3 py-2 rounded hover:bg-gray-200">ตั้งค่า</a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-6 overflow-auto">
    
    <!-- QR Code Generator Section -->
    <section id="qr" class="content-section">
      <h1 class="text-2xl font-bold text-blue-700 mb-6">สร้าง QR Code (ปรับแต่งได้)</h1>
      
      <div class="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto">
        <label class="block mb-2 font-semibold">ข้อความหรือ URL:</label>
        <input id="qrText" type="text" class="w-full p-2 border rounded mb-4" placeholder="ใส่ข้อความ หรือ URL">

        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block mb-1 font-semibold">ขนาด:</label>
            <select id="qrSize" class="w-full p-2 border rounded">
              <option value="200">200 x 200</option>
              <option value="300" selected>300 x 300</option>
              <option value="400">400 x 400</option>
            </select>
          </div>
          <div>
            <label class="block mb-1 font-semibold">สีจุด (Foreground):</label>
            <input type="color" id="qrColor" value="#000000" class="w-full h-[38px] border rounded">
          </div>
        </div>

        <label class="block mb-1 font-semibold">ลักษณะของ QR:</label>
        <select id="qrStyle" class="w-full p-2 border rounded mb-4">
          <option value="square">มาตรฐาน (Square)</option>
          <option value="dots">จุด (Dots)</option>
          <option value="rounded">มุมมน (Rounded)</option>
          <option value="classy">สวยหรู (Classy)</option>
          <option value="classy-rounded">Classy + Rounded</option>
          <option value="extra-rounded">Extra Rounded</option>
        </select>

        <button onclick="generateQR()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">สร้าง QR</button>

        <div id="qrContainer" class="mt-6 text-center"></div>
        <div class="text-center mt-4 hidden" id="downloadBtn">
          <button onclick="downloadQR()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">ดาวน์โหลด</button>
        </div>
      </div>
    </section>
	
    <!-- Short URL Section -->
    <section id="shorturl" class="content-section hidden">
      <h1 class="text-2xl font-bold text-blue-700 mb-6">ย่อ URL (Short URL)</h1>
      
      <div class="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto">
        <label class="block mb-2 font-semibold">กรอกลิงก์ยาว (Long URL):</label>
        <input id="longUrl" type="text" class="w-full p-2 border rounded mb-4" placeholder="https://example.com/very/long/link">

        <button onclick="shortenURL()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">สร้างลิงก์สั้น</button>

        <div id="shortResult" class="mt-4 text-center hidden">
          <p class="mb-2 font-semibold">ลิงก์สั้นของคุณ:</p>
          <div class="bg-gray-50 p-3 rounded border">
            <input id="shortLink" class="p-2 border rounded w-full text-center text-blue-700 font-semibold bg-white mb-2" readonly>
            <div class="flex gap-2 justify-center">
              <button onclick="copyShortLink()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">คัดลอกลิงก์</button>
              <button onclick="testShortLink()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">ทดสอบลิงก์</button>
            </div>
          </div>
        </div>
      </div>
    </section>

  </main>

  <script>
    let qr = null;

    // QR Code Functions
    function generateQR() {
      const text = document.getElementById("qrText").value.trim();
      const size = parseInt(document.getElementById("qrSize").value);
      const color = document.getElementById("qrColor").value;
      const style = document.getElementById("qrStyle").value;

      if (!text) return alert("กรุณากรอกข้อความก่อน");

      if (qr) {
        document.getElementById("qrContainer").innerHTML = "";
      }

      qr = new QRCodeStyling({
        width: size,
        height: size,
        data: text,
        dotsOptions: {
          color: color,
          type: style
        },
        backgroundOptions: {
          color: "#ffffff"
        },
        imageOptions: {
          crossOrigin: "anonymous",
          margin: 5
        }
      });

      qr.append(document.getElementById("qrContainer"));
      document.getElementById("downloadBtn").classList.remove("hidden");
    }

    function downloadQR() {
      if (qr) {
        qr.download({ name: "qr-code", extension: "png" });
      }
    }

    // Short URL Functions
    async function shortenURL() {
      const longUrl = document.getElementById("longUrl").value.trim();
      const resultDiv = document.getElementById("shortResult");
      const shortLinkInput = document.getElementById("shortLink");
      const button = document.querySelector('button[onclick="shortenURL()"]');

      if (!longUrl) {
        alert("กรุณากรอกลิงก์ก่อน");
        return;
      }

      if (!longUrl.startsWith("http://") && !longUrl.startsWith("https://")) {
        alert("กรุณาใส่ URL ที่ถูกต้อง เช่น https://example.com");
        return;
      }

      // Show loading state
      button.disabled = true;
      button.textContent = "กำลังสร้าง...";

      // List of APIs to try
      const apis = [
        {
          name: "TinyURL",
          url: `https://tinyurl.com/api-create.php?url=${encodeURIComponent(longUrl)}`,
          method: "GET",
          parser: (response) => response.text()
        },
        {
          name: "is.gd",
          url: `https://is.gd/create.php?format=simple&url=${encodeURIComponent(longUrl)}`,
          method: "GET", 
          parser: (response) => response.text()
        },
        {
          name: "Shrtco.de",
          url: `https://api.shrtco.de/v2/shorten?url=${encodeURIComponent(longUrl)}`,
          method: "GET",
          parser: async (response) => {
            const data = await response.json();
            if (!data.ok) throw new Error(data.error);
            return data.result.full_short_link;
          }
        }
      ];

      let success = false;

      for (const api of apis) {
        try {
          console.log(`Trying ${api.name}...`);
          
          const response = await fetch(api.url, {
            method: api.method,
            mode: 'cors'
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const shortLink = await api.parser(response);
          
          if (shortLink && shortLink.startsWith('http')) {
            shortLinkInput.value = shortLink;
            resultDiv.classList.remove("hidden");
            success = true;
            break;
          }

        } catch (error) {
          console.error(`${api.name} failed:`, error);
          continue;
        }
      }

      // Reset button state
      button.disabled = false;
      button.textContent = "สร้างลิงก์สั้น";

      if (!success) {
        // If all APIs fail, create a simple fallback
        const fallbackShort = createFallbackShortURL(longUrl);
        shortLinkInput.value = fallbackShort;
        resultDiv.classList.remove("hidden");
        alert("API ภายนอกไม่สามารถใช้ได้ จึงสร้างลิงก์แบบจำลองให้");
      }
    }

    // Fallback function when all APIs fail
    function createFallbackShortURL(longUrl) {
      const hash = btoa(longUrl).replace(/[^a-zA-Z0-9]/g, '').substring(0, 8);
      return `https://short.ly/${hash}`;
    }

    function copyShortLink() {
      const shortLinkInput = document.getElementById("shortLink");
      shortLinkInput.select();
      shortLinkInput.setSelectionRange(0, 99999);
      
      try {
        document.execCommand("copy");
        alert("คัดลอกลิงก์สั้นแล้ว!");
      } catch (err) {
        // Fallback for modern browsers
        navigator.clipboard.writeText(shortLinkInput.value).then(() => {
          alert("คัดลอกลิงก์สั้นแล้ว!");
        }).catch(() => {
          alert("ไม่สามารถคัดลอกได้ กรุณาคัดลอกด้วยตนเอง");
        });
      }
    }

    function testShortLink() {
      const shortLink = document.getElementById("shortLink").value;
      if (shortLink) {
        window.open(shortLink, '_blank');
      }
    }

    // Navigation Functions
    function showSection(sectionId) {
      // Hide all sections
      document.querySelectorAll(".content-section").forEach(section => {
        section.classList.add("hidden");
      });
      
      // Show target section
      const targetSection = document.getElementById(sectionId);
      if (targetSection) {
        targetSection.classList.remove("hidden");
      }
      
      // Update navigation active state
      document.querySelectorAll(".nav-link").forEach(link => {
        link.classList.remove("bg-blue-100", "text-blue-700", "font-medium");
        link.classList.add("hover:bg-gray-200");
      });
      
      const activeLink = document.querySelector(`a[href="#${sectionId}"]`);
      if (activeLink) {
        activeLink.classList.add("bg-blue-100", "text-blue-700", "font-medium");
        activeLink.classList.remove("hover:bg-gray-200");
      }
    }

    // Event Listeners
    document.addEventListener("DOMContentLoaded", () => {
      // Handle navigation clicks
      document.querySelectorAll(".nav-link").forEach(link => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          const href = link.getAttribute("href");
          if (href.startsWith("#")) {
            const sectionId = href.substring(1);
            showSection(sectionId);
            window.location.hash = href;
          }
        });
      });

      // Handle initial hash
      const hash = window.location.hash;
      if (hash) {
        const sectionId = hash.substring(1);
        showSection(sectionId);
      } else {
        showSection("qr"); // Default to QR section
      }
    });

    // Handle hash changes
    window.addEventListener("hashchange", () => {
      const hash = window.location.hash;
      if (hash) {
        const sectionId = hash.substring(1);
        showSection(sectionId);
      }
    });

    // Enter key support for inputs
    document.getElementById("qrText").addEventListener("keypress", (e) => {
      if (e.key === "Enter") generateQR();
    });

    document.getElementById("longUrl").addEventListener("keypress", (e) => {
      if (e.key === "Enter") shortenURL();
    });
  </script>

</body>
</html>
